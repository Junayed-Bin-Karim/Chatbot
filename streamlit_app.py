import streamlit as st
import time
import random
import json
from datetime import datetime

# Mood-based responses - ChatGPT style
MOOD_RESPONSES = {
    "happy": {
        "greeting": [
            "рж╣рзНржпрж╛рж▓рзЛ! ржЖржкржирж╛рж░ рж╕рж╛ржерзЗ ржХржерж╛ ржмрж▓рзЗ ржЖржорж╛рж░ржУ ржЦрзБржм ржнрж╛рж▓рзЛ рж▓рж╛ржЧржЫрзЗ! ЁЯШК",
            "ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо! ржЖржЬржХрзЗ ржЖржкржирж╛рж░ ржЖржЪрж░ржг ржжрзЗржЦрзЗ ржоржирзЗ рж╣ржЪрзНржЫрзЗ ржЦрзБржм ржнрж╛рж▓рзЛ mood ржП ржЖржЫрзЗржи! ЁЯМЯ",
            "рж╣рж╛ржЗ! ржЖржкржирж╛рж░ ржЖржиржирзНржж ржЖржорж╛ржХрзЗржУ ржкрзНрж░ржнрж╛ржмрж┐ржд ржХрж░ржЫрзЗ! тЬи"
        ],
        "general": [
            "ржУржпрж╝рж╛ржУ! ржПржЯрж┐чЬЯцШп ржЪржорзОржХрж╛рж░! ржЖржкржирж╛рж░ positivity contagious! ЁЯМИ",
            "ржЖржкржирж╛рж░ ржХржерж╛ржпрж╝ ржПржХржЯрж╛ ржмрж┐рж╢рзЗрж╖ energy ржЖржЫрзЗ, ржЖржорж┐ feel ржХрж░рждрзЗ ржкрж╛рж░ржЫрж┐! ЁЯТл",
            "ржПржЗ optimistic attitudeчЬЯцШп ржЦрзБржмржЗ inspiring! ЁЯОЙ"
        ],
        "problem": [
            "ржЖржкржирж╛рж░ optimistic approachчЬЯцШп ржкрзНрж░рж╢ржВрж╕ржирзАржпрж╝! ржПржЗ attitude ржирж┐ржпрж╝рзЗ ржПhead ржпрж╛ржи! ЁЯЪА",
            "рж╕ржорж╕рзНржпрж╛ ржерж╛ржХрждрзЗржЗ ржкрж╛рж░рзЗ, ржХрж┐ржирзНрждрзБ ржЖржкржирж╛рж░ positive mindset рж╕ржм overcome ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ! ЁЯТк",
            "ржЖржкржирж╛рж░ ржорждрзЛ positive person ржПрж░ ржЬржирзНржп ржХрзЛржирзЛ problemржЗ ржмржбрж╝ ржирж╛! ЁЯМЯ"
        ]
    },
    "sad": {
        "greeting": [
            "рж╣рзНржпрж╛рж▓рзЛ... ржЖржорж┐ feel ржХрж░рждрзЗ ржкрж╛рж░ржЫрж┐ ржЖржкржирж┐ ржЖржЬ ржПржХржЯрзБ down feel ржХрж░ржЫрзЗржи ЁЯлВ",
            "ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо... ржЖржорж┐ ржЖржкржирж╛рж░ ржкрж╛рж╢рзЗ ржЖржЫрж┐, always ЁЯТЩ",
            "рж╣рж╛ржЗ... ржХржерж╛ ржмрж▓рзБржи, ржЖржорж┐ рж╢рзБржиржЫрж┐ ЁЯМ╕"
        ],
        "general": [
            "ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐... sometimes life gives us tough moments ЁЯМзя╕П",
            "ржПржЗ feelingsчЬЯцШп valid... ржЖржкржирж╛рж░ ржпрж╛ feel ржХрж░ржЫрзЗржи рждрж╛ рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХ ЁЯлВ",
            "ржХржерж╛ржЧрзБрж▓рзЛ share ржХрж░рж╛рж░ ржЬржирзНржп ржзржирзНржпржмрж╛ржж... ржЖржорж┐ appreciate ржХрж░ржЫрж┐ ЁЯМ╝"
        ],
        "problem": [
            "ржПржЗ difficult time ржП ржЖржорж┐ ржЖржкржирж╛рж░ рж╕рж╛ржерзЗ ржЖржЫрж┐ ЁЯТк",
            "Remember, dark clouds always pass... sunshineф╕АхоЪф╝Ъ ржЖрж╕ржмрзЗ ЁЯМИ",
            "ржЖржкржирж┐ alone ржиржи... ржЖржорж░рж╛ together ржПржЗ situation handle ржХрж░рждрзЗ ржкрж╛рж░рж┐ ЁЯдЭ"
        ]
    },
    "angry": {
        "greeting": [
            "рж╣рзНржпрж╛рж▓рзЛ... ржЖржорж┐ sense ржХрж░рждрзЗ ржкрж╛рж░ржЫрж┐ ржЖржкржирж┐ frustrated ЁЯМА",
            "ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо... take a deep breath, ржЖржорж┐ here to listen ЁЯМкя╕П",
            "рж╣рж╛ржЗ... let's talk about what's bothering you ЁЯФе"
        ],
        "general": [
            "ржЖржорж┐ understand your frustration... rageчЬЯцШп powerful emotion ЁЯТе",
            "ржПржЗ anger express ржХрж░рж╛чЬЯцШп important... keep sharing ЁЯМЛ",
            "ржЖржкржирж╛рж░ feelingsчЬЯцШп justified... continue expressing ЁЯЧгя╕П"
        ],
        "problem": [
            "Let's channel this anger into positive energy тЪб",
            "ржПржЗ situationчЬЯцШп temporary... solutionsф╕АхоЪцЬЙ ЁЯМИ",
            "ржЖржкржирж╛рж░ strengthчЬЯцШп admirable, even in anger ЁЯТк"
        ]
    },
    "neutral": {
        "greeting": [
            "рж╣рзНржпрж╛рж▓рзЛ! ржХрзЗржоржи ржЖржЫрзЗржи? ЁЯдЦ",
            "ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо! ржХржерж╛ ржмрж▓рзБржи ЁЯТм",
            "рж╣рж╛ржЗ! ржЖржЬржХрзЗ ржХрзЗржоржи ржпрж╛ржЪрзНржЫрзЗ? ЁЯМЯ"
        ],
        "general": [
            "ржмрзБржЭрждрзЗ ржкрж╛рж░рж▓рж╛ржо! ржЖрж░ржУ ржмрж▓рзБржи... ЁЯТн",
            "Interesting! Continue... ЁЯОп",
            "Thanks for sharing! What's on your mind? ЁЯТл"
        ],
        "problem": [
            "Let's think about solutions together ЁЯдФ",
            "ржПржЗ problem solve ржХрж░рж╛ ржпрж╛ржпрж╝! ЁЯТб",
            "ржЖржорж┐ help ржХрж░рждрзЗ ржкрж╛рж░рж┐! ЁЯФз"
        ]
    }
}

# Voice recording function
def record_voice():
    try:
        from audio_recorder_streamlit import audio_recorder
        audio_bytes = audio_recorder()
        if audio_bytes:
            # Save audio temporarily
            with open("temp_audio.wav", "wb") as f:
                f.write(audio_bytes)
            return "temp_audio.wav"
    except:
        st.warning("Voice recording not available")
    return None

# Convert speech to text
def speech_to_text(audio_file):
    try:
        import speech_recognition as sr
        r = sr.Recognizer()
        with sr.AudioFile(audio_file) as source:
            audio = r.record(source)
            text = r.recognize_google(audio, language='bn-BD')
            return text
    except:
        return None

# Simple emotion detection
def detect_user_mood(text):
    text_lower = text.lower()
    
    happy_words = ['happy', 'joy', 'good', 'great', 'awesome', 'ржЦрзБрж╢рж┐', 'ржнрж╛рж▓рзЛ', 'ржоржЬрж╛', 'ржЕрж╕рж╛ржзрж╛рж░ржг', 'ржмрж╛рж╣']
    sad_words = ['sad', 'bad', 'unhappy', 'ржжрзБржГржЦ', 'ржЦрж╛рж░рж╛ржк', 'ржХрж╖рзНржЯ', 'ржмрж┐рж╖ржгрзНржг', 'рж╣рждрж╛рж╢']
    angry_words = ['angry', 'mad', 'hate', 'frustrated', 'рж░рж╛ржЧ', 'ржХрзНрж░рзЛржз', 'ржЭржЧржбрж╝рж╛', 'ржмрж┐рж░ржХрзНржд']
    
    happy_count = sum(1 for word in happy_words if word in text_lower)
    sad_count = sum(1 for word in sad_words if word in text_lower)
    angry_count = sum(1 for word in angry_words if word in text_lower)
    
    if happy_count > sad_count and happy_count > angry_count:
        return "happy", "ржЖржкржирж┐ ржЖржЬ ржЦрзБржмржЗ ржЦрзБрж╢рж┐ ржПржмржВ positive mood ржП ржЖржЫрзЗржи! ЁЯШК"
    elif sad_count > happy_count and sad_count > angry_count:
        return "sad", "ржЖржкржирж┐ ржЖржЬ ржПржХржЯрзБ ржжрзБржГржЦрж┐ржд ржмрж╛ down feel ржХрж░ржЫрзЗржи ЁЯлВ"
    elif angry_count > happy_count and angry_count > sad_count:
        return "angry", "ржЖржкржирж┐ ржХрж┐ржЫрзБржЯрж╛ рж░рж╛ржЧрж╛ржирзНржмрж┐ржд ржмрж╛ frustrated feel ржХрж░ржЫрзЗржи ЁЯМкя╕П"
    else:
        return "neutral", "ржЖржкржирж╛рж░ mood рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХ ржЖржЫрзЗ ЁЯдЦ"

# Smart response generator
def generate_smart_response(user_input, user_mood, conversation_history):
    # Analyze conversation context
    context_keywords = {
        "work": ["ржХрж╛ржЬ", "ржЕржлрж┐рж╕", "ржкрзНрж░ржЬрзЗржХрзНржЯ", "ржмрж╕"],
        "family": ["ржкрж░рж┐ржмрж╛рж░", "ржмрж╛ржмрж╛", "ржорж╛", "ржнрж╛ржЗ", "ржмрзЛржи"],
        "love": ["ржкрзНрж░рзЗржо", "ржЧрж╛рж░рзНрж▓ржлрзНрж░рзЗржирзНржб", "ржмржпрж╝ржлрзНрж░рзЗржирзНржб", "ржмрж┐ржпрж╝рзЗ"],
        "health": ["рж╕рзНржмрж╛рж╕рзНржерзНржп", "ржбрж╛ржХрзНрждрж╛рж░", "ржУрж╖рзБржз", "ржмрзНржпрж╛ржерж╛"]
    }
    
    # Detect context
    current_context = "general"
    for context, keywords in context_keywords.items():
        if any(keyword in user_input for keyword in keywords):
            current_context = context
            break
    
    # Get appropriate response based on mood and context
    responses = MOOD_RESPONSES[user_mood]
    
    if "hello" in user_input.lower() or "hi" in user_input.lower() or "рж╣рзНржпрж╛рж▓рзЛ" in user_input:
        return random.choice(responses["greeting"])
    elif any(word in user_input for word in ["problem", "issue", "рж╕ржорж╕рзНржпрж╛", "ржХрж╖рзНржЯ"]):
        return random.choice(responses["problem"])
    else:
        response = random.choice(responses["general"])
        
        # Add context-specific advice
        if current_context == "work":
            response += "\n\nржХрж╛ржЬрзЗрж░ ржмрзНржпрж╛ржкрж╛рж░рзЗ ржмрж▓ржЫрзЗржи? Work-life balanceчЬЯцШп important! ЁЯТ╝"
        elif current_context == "family":
            response += "\n\nржкрж░рж┐ржмрж╛рж░рзЗрж░ ржХржерж╛? FamilyчЬЯцШп ржЖржорж╛ржжрзЗрж░ biggest strength! ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж"
        elif current_context == "love":
            response += "\n\nржкрзНрж░рзЗржорзЗрж░ ржХржерж╛? LoveчЬЯцШп beautiful feeling! тЭдя╕П"
        elif current_context == "health":
            response += "\n\nрж╕рзНржмрж╛рж╕рзНржерзНржпрзЗрж░ ржХржерж╛? HealthчЬЯцШп wealth! ЁЯПе"
            
        return response

def main():
    st.set_page_config(
        page_title="Smart ржмрж╛ржВрж▓рж╛ Chatbot - ржЖржкржирж╛рж░ Mood ржмрзБржЭржмрзЗ!",
        page_icon="ЁЯдЦ",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # Custom CSS
    st.markdown("""
    <style>
    .main-header {
        font-size: 3rem;
        color: #2E86AB;
        text-align: center;
        margin-bottom: 2rem;
    }
    .mood-indicator {
        padding: 10px;
        border-radius: 10px;
        margin: 5px;
        text-align: center;
        font-weight: bold;
    }
    .happy { background-color: #FFEAA7; color: #E17055; }
    .sad { background-color: #74B9FF; color: #0984E3; }
    .angry { background-color: #FF7675; color: #D63031; }
    .neutral { background-color: #DFE6E9; color: #2D3436; }
    .voice-btn {
        background-color: #00B894;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    </style>
    """, unsafe_allow_html=True)
    
    st.markdown('<div class="main-header"> Smart ржмрж╛ржВрж▓рж╛ Chatbot</div>', unsafe_allow_html=True)
    st.markdown("### **ржЖржкржирж╛рж░ Mood ржмрзБржЭрзЗ Response ржжрж┐ржмрзЗ!** ")
    
    # Initialize session state
    if "messages" not in st.session_state:
        st.session_state.messages = []
    if "user_mood" not in st.session_state:
        st.session_state.user_mood = "neutral"
    if "mood_description" not in st.session_state:
        st.session_state.mood_description = "ржЖржкржирж╛рж░ mood ржПржЦржиржУ analyze ржХрж░рж╛ рж╣ржпрж╝ржирж┐"
    
    # Sidebar
    with st.sidebar:
        st.header("ЁЯОЫя╕П Control Panel")
        
        # Mood display
        st.subheader("ЁЯОн ржЖржкржирж╛рж░ Current Mood")
        mood_class = st.session_state.user_mood
        st.markdown(f'<div class="mood-indicator {mood_class}">{st.session_state.mood_description}</div>', 
                   unsafe_allow_html=True)
        
        # Voice recording section
        st.subheader("ЁЯОд Voice Input")
        st.info("Voice recording feature coming soon!")
        
        # Statistics
        if st.session_state.messages:
            st.subheader("ЁЯУК Statistics")
            mood_count = {}
            for msg in st.session_state.messages:
                if msg["role"] == "user" and "mood" in msg:
                    mood_count[msg["mood"]] = mood_count.get(msg["mood"], 0) + 1
            
            if mood_count:
                st.write("**Mood Distribution:**")
                for mood, count in mood_count.items():
                    st.write(f"- {mood}: {count} ржмрж╛рж░")
        
        # Clear chat
        if st.button("ЁЯЧСя╕П Chat Clear ржХрж░рзБржи"):
            st.session_state.messages = []
            st.session_state.user_mood = "neutral"
            st.session_state.mood_description = "Chat cleared!"
            st.rerun()
    
    # Main chat area
    col1, col2 = st.columns([3, 1])
    
    with col1:
        # Display chat messages
        for message in st.session_state.messages:
            with st.chat_message(message["role"]):
                st.markdown(message["content"])
                if message["role"] == "user" and "mood" in message:
                    st.caption(f"Mood: {message['mood']}")
    
    with col2:
        st.subheader("ЁЯТб Tips")
        st.info("""
        Try saying:
        - "ржЖржЬржХрзЗ ржЖржорж╛рж░ ржЦрзБржм ржнрж╛рж▓рзЛ рж▓рж╛ржЧржЫрзЗ"
        - "ржЖржорж┐ ржПржХржЯрзБ upset feel ржХрж░ржЫрж┐"
        - "ржХрж╛ржЬ ржирж┐ржпрж╝рзЗ problem рж╣ржЪрзНржЫрзЗ"
        - "ржкрж░рж┐ржмрж╛рж░рзЗрж░ situation ржнрж╛рж▓рзЛ ржирж╛"
        """)
    
    # Chat input with voice option
    st.markdown("---")
    col1, col2 = st.columns([4, 1])
    
    with col1:
        user_input = st.chat_input("ржЖржкржирж╛рж░ message рж▓рж┐ржЦрзБржи ржмрж╛ voice record ржХрж░рзБржи...")
    
    with col2:
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("ЁЯОд Voice Input", use_container_width=True):
            st.info("Voice recording feature will be added soon!")
    
    if user_input:
        # Add user message to chat
        st.session_state.messages.append({"role": "user", "content": user_input})
        
        # Detect user mood
        current_mood, mood_desc = detect_user_mood(user_input)
        st.session_state.user_mood = current_mood
        st.session_state.mood_description = mood_desc
        
        # Store mood with user message
        st.session_state.messages[-1]["mood"] = current_mood
        
        # Display user message
        with st.chat_message("user"):
            st.markdown(user_input)
            st.caption(f"Mood: {current_mood}")
        
        # Generate and display bot response
        with st.chat_message("assistant"):
            with st.spinner("ЁЯдФ Thinking..."):
                time.sleep(1)  # Simulate thinking
                
                # Generate smart response
                response = generate_smart_response(
                    user_input, 
                    current_mood, 
                    st.session_state.messages
                )
                
                # Type effect
                message_placeholder = st.empty()
                full_response = ""
                for char in response:
                    full_response += char
                    message_placeholder.markdown(full_response + "тЦМ")
                    time.sleep(0.01)
                message_placeholder.markdown(full_response)
                
                # Add mood-based advice
                if current_mood == "sad":
                    st.info("ЁЯТб **рж╕рж╛ржЬрзЗрж╢ржи:** Music рж╢рзБржирзБржи, walk ржХрж░рзБржи, ржХрж╛ржЫрзЗрж░ ржорж╛ржирзБрж╖рзЗрж░ рж╕рж╛ржерзЗ ржХржерж╛ ржмрж▓рзБржи")
                elif current_mood == "angry":
                    st.info("ЁЯТб **рж╕рж╛ржЬрзЗрж╢ржи:** Deep breathing ржХрж░рзБржи, counting ржХрж░рзБржи, break ржирж┐ржи")
                elif current_mood == "happy":
                    st.success("ЁЯОЙ **рж╕рж╛ржЬрзЗрж╢ржи:** ржПржЗ positive energy maintain ржХрж░рзБржи, others ржХрзЗ inspire ржХрж░рзБржи!")
        
        # Add bot response to history
        st.session_state.messages.append({
            "role": "assistant", 
            "content": response,
            "mood_aware": True
        })

if __name__ == "__main__":
    main()

